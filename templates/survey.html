<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey - Question {{ question_num }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script>
        function selectCard(input) {
            // Update selected state immediately
            const allCards = document.querySelectorAll('.card-option');
            allCards.forEach(card => card.classList.remove('selected'));
            input.closest('.card-option').classList.add('selected');
            
            // Auto-advance after 0.3 seconds
            setTimeout(function() {
                const form = document.getElementById('surveyForm');
                const nextButton = form.querySelector('button[name="next"]');
                const submitButton = form.querySelector('button[name="submit"]');
                if (nextButton) {
                    nextButton.click();
                } else if (submitButton) {
                    submitButton.click();
                }
            }, 300);
        }

        // Validate on submit for non-ranking questions
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('surveyForm');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                const submitter = e.submitter;
                
                // Only validate on next/submit buttons, not previous
                if (submitter && (submitter.name === 'next' || submitter.name === 'submit')) {
                    const rankingContainer = document.querySelector('.ranking-container');
                    
                    // If not ranking page, check if an option is selected
                    if (!rankingContainer) {
                        const radioButtons = form.querySelectorAll('input[type="radio"]');
                        const isAnyChecked = Array.from(radioButtons).some(radio => radio.checked);
                        
                        if (radioButtons.length > 0 && !isAnyChecked) {
                            e.preventDefault();
                            alert('Please select an option before proceeding.');
                        }
                    }
                }
            });
        });

        // Click-based ranking functionality
        document.addEventListener('DOMContentLoaded', function() {
            const rankingContainer = document.querySelector('.ranking-container');
            if (!rankingContainer) return;

            const rankMap = new Map(); // Tracks card value -> rank
            let nextRank = 1;

            // Initialize cards grid
            const cardsGrid = document.getElementById('cardsGrid');
            if (!cardsGrid) return;

            const cards = cardsGrid.querySelectorAll('.ranking-card');
            cards.forEach(card => {
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    const cardValue = this.dataset.value;
                    
                    if (rankMap.has(cardValue)) {
                        // De-rank the card
                        rankMap.delete(cardValue);
                        this.classList.remove('ranked');
                        this.querySelector('.rank-badge').textContent = '';
                        nextRank--;
                    } else {
                        // Rank the card
                        if (nextRank <= 8) {
                            rankMap.set(cardValue, nextRank);
                            this.classList.add('ranked');
                            this.querySelector('.rank-badge').textContent = nextRank;
                            nextRank++;
                        }
                    }
                    
                    updateHiddenInput();
                });
            });

            function updateHiddenInput() {
                const sortedRanking = Array.from(rankMap.entries())
                    .sort((a, b) => a[1] - b[1])
                    .map(entry => entry[0]);
                
                document.getElementById('rankingOrder').value = sortedRanking.join(',');
            }

            // Update on form submit
            document.getElementById('surveyForm').addEventListener('submit', function(e) {
                updateHiddenInput();
                
                // Only check if all cards are ranked when clicking submit button (not previous)
                const submitter = e.submitter;
                if (submitter && submitter.name === 'submit') {
                    if (rankMap.size !== 8) {
                        e.preventDefault();
                        alert('Please rank all 8 cards before submitting!');
                    }
                }
            });
        });
    </script>
</head>
<body>
    <div class="container {% if question.type == 'ranking' %}ranking-page{% endif %}">
        <div class="progress-container">
            <div class="progress-bar" style="width: {{ progress }}%"></div>
        </div>
        
        <div class="question-counter">
            Question {{ question_num }} of {{ total_questions }}
        </div>
        
        <form method="POST" class="survey-form" id="surveyForm">
            <h1>{{ question.question }}</h1>
            {% if question.description %}
            <p class="question-description">{{ question.description }}</p>
            {% endif %}
            
            {% if question.type == 'ranking' %}
                <div class="ranking-container">
                    <div class="ranking-instructions">
                        Click on each card to rank them from 1 (Most Important) to 8 (Least Important). Click again to deselect.
                    </div>
                    
                    <!-- Cards grid -->
                    <div id="cardsGrid" class="cards-grid">
                        {% for item in selected_items %}
                            <div class="ranking-card" data-value="{{ item.text }}">
                                <div class="card-image-container">
                                    <img src="{{ url_for('static', filename='images/' + item.image) }}" alt="{{ item.title }}" class="card-image">
                                </div>
                                <div class="rank-badge"></div>
                                <div class="card-text">
                                    <div class="card-title">{{ item.title }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <input type="hidden" name="ranking_order" id="rankingOrder">
                </div>
            {% else %}
                <div class="card-group {% if question.options and not question.options[0].image %}vertical{% endif %}">
                    {% for option in question.options %}
                        <label class="card-option {% if saved_answer == option.text %}selected{% endif %}">
                            <input type="radio" name="{{ question.name }}" value="{{ option.text }}" 
                                   {% if saved_answer == option.text %}checked{% endif %}
                                   onchange="selectCard(this)">
                            {% if option.image %}
                                <div class="card-image-container">
                                    <img src="{{ url_for('static', filename='images/' + option.image) }}" alt="{{ option.text }}" class="card-image">
                                </div>
                                <div class="card-text">
                                    <div class="card-title">{{ option.title }}</div>
                                    <div class="card-tooltip">{{ option.description }}</div>
                                </div>
                            {% else %}
                                <div class="simple-text-option">
                                    {{ option.text }}
                                </div>
                            {% endif %}
                        </label>
                    {% endfor %}
                </div>
            {% endif %}
            
            <div class="button-group">
                {% if question_num > 1 %}
                    <button type="submit" name="previous" class="btn btn-secondary">Previous</button>
                {% endif %}
                
                {% if question_num < total_questions %}
                    <button type="submit" name="next" class="btn btn-primary">Next</button>
                {% else %}
                    <button type="submit" name="submit" class="btn btn-primary">Submit</button>
                {% endif %}
            </div>
        </form>
    </div>
</body>
</html>
